<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SimpleKas ‚Äî Pengelolaan Keuangan Usaha</title>
<style>
  :root{
    --bg:#f3f7fb;
    --card:#ffffff;
    --accent:#0b84ff;
    --danger:#ef4444;
    --muted:#475569;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#0b1b2b;background:linear-gradient(180deg,var(--bg),#e9f1ff);-webkit-font-smoothing:antialiased}
  .wrap{max-width:820px;margin:18px auto;padding:16px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#00c6ff);display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:20px;box-shadow:0 8px 22px rgba(11,132,255,0.12)}
  h1{font-size:20px;margin:0}
  p.lead{margin:0;color:var(--muted);font-size:13px}
  main{display:grid;grid-template-columns:1fr 360px;gap:12px}
  @media(max-width:880px){main{grid-template-columns:1fr;padding:0} .right {order:2}}
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 8px 26px rgba(12,24,48,0.06)}
  .big{font-size:28px;font-weight:800}
  .muted{color:var(--muted);font-size:13px}
  .controls{display:flex;gap:8px;align-items:center}
  button{cursor:pointer}
  .btn{padding:10px 12px;border-radius:10px;border:none;font-weight:700}
  .btn-primary{background:var(--accent);color:white}
  .btn-ghost{background:transparent;border:1px solid #e6f0ff}
  .btn-danger{background:var(--danger);color:white}
  .form-row{display:flex;gap:8px;margin-top:12px}
  input[type="number"], input[type="text"], select, input[type="date"]{padding:10px;border-radius:10px;border:1px solid #e6eefc;font-size:15px;flex:1}
  input[type="number"]{width:150px}
  .chips{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .chip{padding:10px 14px;border-radius:12px;border:1px solid #e6f2ff;background:linear-gradient(180deg,#fff,#fbfdff);font-weight:700;cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:8px;text-align:left;border-bottom:1px solid #f1f6fb;font-size:14px}
  .t-center{text-align:center}
  .income{color:green;font-weight:800}
  .expense{color:var(--danger);font-weight:800}
  .empty{padding:30px;text-align:center;color:var(--muted);border-radius:10px;border:2px dashed #eef6ff;margin-top:8px}
  .toolbar{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:8px}
  footer{margin-top:12px;text-align:center;color:var(--muted);font-size:13px}
  .small{font-size:13px;color:var(--muted)}
  .sr{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
</style>
</head>
<body>
  <div class="wrap" role="application" aria-label="Aplikasi SimpleKas">
    <header>
      <div class="brand">
        <div class="logo">‚öñÔ∏è</div>
        <div>
          <h1>KasKuy</h1>
          <p class="lead">Mudah‚ÄîCepat‚ÄîAkurat untuk catat pemasukan & pengeluaran</p>
        </div>
      </div>
      <div class="controls">
        <button id="voiceToggle" class="btn btn-ghost" title="Suara konfirmasi">üîä Suara: On</button>
        <button id="exportBtn" class="btn btn-primary" title="Export CSV">‚¨á Export</button>
      </div>
    </header>

    <main>
      <!-- LEFT: daftar & ringkasan -->
      <section class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div class="small">Saldo Saat Ini</div>
            <div class="big" id="saldo">Rp 0</div>
            <div class="small" id="lastUpdate">Belum ada transaksi</div>
          </div>
          <div style="text-align:right">
            <div class="small">Ringkasan Bulanan</div>
            <div class="small">Pemasukan: <strong id="sumIn">Rp 0</strong></div>
            <div class="small">Pengeluaran: <strong id="sumOut">Rp 0</strong></div>
          </div>
        </div>

        <div class="toolbar">
          <div style="display:flex;gap:8px;align-items:center">
            <select id="filterType" aria-label="Filter jenis">
              <option value="all">Semua</option>
              <option value="in">Pemasukan</option>
              <option value="out">Pengeluaran</option>
            </select>
            <input type="date" id="filterFrom" />
            <input type="date" id="filterTo" />
            <button id="applyFilter" class="btn btn-ghost">üîé Filter</button>
            <button id="resetFilter" class="btn btn-ghost">Reset</button>
          </div>
          <div class="small">Total: <span id="count">0</span></div>
        </div>

        <div id="listArea" style="margin-top:10px;">
          <table aria-label="Daftar transaksi">
            <thead><tr><th>Tgl</th><th>Deskripsi</th><th class="t-center">Jenis</th><th class="t-center">Jumlah</th><th></th></tr></thead>
            <tbody id="txBody"></tbody>
          </table>
          <div id="empty" class="empty" style="display:none">Belum ada transaksi. Tambah di sebelah kanan ‚Üí</div>
        </div>
      </section>

      <!-- RIGHT: tambah transaksi & tools -->
      <aside class="right">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Tambah Transaksi</strong><div class="small">Pilih jenis, isi jumlah, deskripsi, dan tanggal</div></div>
            <div class="small" id="quickSaldo">Rp 0</div>
          </div>

          <div class="form-row" style="margin-top:12px">
            <select id="type">
              <option value="in">Pemasukan (+)</option>
              <option value="out">Pengeluaran (-)</option>
            </select>
            <input id="amount" type="number" min="0" placeholder="Jumlah (Rp)" aria-label="Jumlah"/>
          </div>

          <div class="form-row" style="margin-top:10px">
            <input id="desc" type="text" placeholder="Deskripsi (mis. Jualan pagi)" />
          </div>

          <div class="form-row">
            <input id="date" type="date" />
            <button id="addBtn" class="btn btn-primary">+ Tambah</button>
          </div>

          <div class="chips" aria-hidden="true">
            <div class="chip" data-amt="50000">Rp 50.000</div>
            <div class="chip" data-amt="100000">Rp 100.000</div>
            <div class="chip" data-amt="150000">Rp 150.000</div>
            <div class="chip" data-amt="200000">Rp 200.000</div>
          </div>

          <div class="small" style="margin-top:10px">Tip: Gunakan chip untuk cepat isi jumlah. Tekan Enter saat input aktif untuk tambah.</div>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <strong>Backup & Lainnya</strong>
          <p class="small">Simpan atau pulihkan data mudah dari file di komputer.</p>
          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <button id="downloadJson" class="btn btn-ghost">Download JSON</button>
            <input type="file" id="fileRestore" accept=".json" style="display:none"/>
            <button id="openRestore" class="btn btn-ghost">Unggah JSON</button>
            <button id="resetMonth" class="btn btn-danger" title="Reset sekarang (arsip dibuat)">Reset Bulan Ini</button>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button id="printBtn" class="btn btn-ghost">Cetak Ringkasan</button>
          </div>
        </div>
      </aside>
    </main>

    <footer>KasKuy by ‚Äî Paan ‚Ä¢ Data Keuangan Simple Untuk Usaha</footer>
    <div class="sr" id="sr"></div>
  </div>

<script>
/*
  SimpleKas - simplified single file
  LocalStorage keys:
    - sk_tx_v2           : array transaksi saat ini
    - sk_last_month_v2   : "YYYY-MM" terakhir reset (string)
    - sk_archive_v2      : object { "YYYY-MM": [transactions], ... }
    - sk_voice_v2        : boolean
*/

(function(){
  'use strict';
  const KEY = 'sk_tx_v2';
  const KEY_MONTH = 'sk_last_month_v2';
  const KEY_ARCH = 'sk_archive_v2';
  const KEY_VOICE = 'sk_voice_v2';

  // DOM
  const $ = id => document.getElementById(id);
  const txBody = $('txBody'), saldoEl = $('saldo'), sumInEl = $('sumIn'), sumOutEl = $('sumOut'), lastUpdate = $('lastUpdate'), countEl = $('count'), quickSaldo = $('quickSaldo');
  const typeEl = $('type'), amtEl = $('amount'), descEl = $('desc'), dateEl = $('date'), addBtn = $('addBtn');
  const filterType = $('filterType'), filterFrom = $('filterFrom'), filterTo = $('filterTo'), applyFilter = $('applyFilter'), resetFilter = $('resetFilter');
  const downloadJson = $('downloadJson'), openRestore = $('openRestore'), fileRestore = $('fileRestore'), resetMonthBtn = $('resetMonth'), exportBtn = $('exportBtn'), printBtn = $('printBtn'), voiceToggle = $('voiceToggle');

  // state
  let tx = [];
  const todayISO = new Date().toISOString().slice(0,10);
  if(!dateEl.value) dateEl.value = todayISO;

  // voice default on
  let voice = (localStorage.getItem(KEY_VOICE)===null) ? true : JSON.parse(localStorage.getItem(KEY_VOICE));
  updateVoiceLabel();

  // --- Utilities ---
  function saveAll(){
    // always save transactions immediately (auto-save)
    localStorage.setItem(KEY, JSON.stringify(tx));
  }
  function loadAll(){
    try {
      const raw = localStorage.getItem(KEY);
      if(!raw) return null;
      return JSON.parse(raw);
    } catch(e){ console.error(e); return null; }
  }
  function loadArchive(){ try { return JSON.parse(localStorage.getItem(KEY_ARCH) || '{}'); } catch(e){ return {}; } }
  function saveArchive(obj){ localStorage.setItem(KEY_ARCH, JSON.stringify(obj)); }
  function money(n){
    const num = Number(n) || 0;
    return 'Rp ' + num.toLocaleString('id-ID');
  }
  function speak(text){
    if(!voice) return;
    if('speechSynthesis' in window){
      try {
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'id-ID';
        speechSynthesis.cancel();
        speechSynthesis.speak(u);
      } catch(e){ /* ignore */ }
    }
  }
  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,7); }

  // --- Monthly auto-reset ---
  function monthKey(d = new Date()){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    return `${y}-${m}`;
  }
  function doMonthlyCheck(){
    const last = localStorage.getItem(KEY_MONTH);
    const now = monthKey();
    if(!last){
      // first time: ensure storage created and record month
      if(!localStorage.getItem(KEY)) {
        tx = [];
        saveAll();
      } else {
        tx = loadAll() || [];
      }
      localStorage.setItem(KEY_MONTH, now);
      return;
    }
    if(last !== now){
      // archive previous month (if any), then reset tx
      const prevData = loadAll() || [];
      const arch = loadArchive();
      if(prevData && prevData.length){
        arch[last] = prevData;
        saveArchive(arch);
      }
      tx = [];
      saveAll();
      localStorage.setItem(KEY_MONTH, now);
      alert('Transaksi otomatis direset untuk bulan baru. Data bulan sebelumnya disimpan sebagai arsip.');
      speak('Data direset untuk bulan baru. Arsip tersimpan.');
    } else {
      tx = loadAll() || [];
    }
  }

  // --- Render & calculations ---
  function updateUI(list){
    // list: array to display (already sorted)
    txBody.innerHTML = '';
    if(!list.length){
      $('empty').style.display = '';
    } else $('empty').style.display = 'none';

    list.forEach(t => {
      const tr = document.createElement('tr');
      const d = new Date(t.date);
      tr.innerHTML = `
        <td>${d.toLocaleDateString('id-ID')}</td>
        <td>${escapeHtml(t.desc)}</td>
        <td class="t-center">${t.type === 'in' ? '<span class="income">Pemasukan</span>' : '<span class="expense">Pengeluaran</span>'}</td>
        <td class="t-center">${money(t.amount)}</td>
        <td class="t-center"><button data-id="${t.id}" class="del btn btn-ghost">Hapus</button></td>
      `;
      txBody.appendChild(tr);
    });
    // bind delete
    txBody.querySelectorAll('.del').forEach(b => {
      b.addEventListener('click', e => {
        const id = e.target.dataset.id;
        if(!confirm('Yakin ingin menghapus transaksi?')) return;
        tx = tx.filter(x => x.id !== id);
        saveAll(); refreshAll();
        speak('Transaksi dihapus');
      });
    });

    // totals
    let inSum = 0, outSum = 0;
    tx.forEach(t => { if(t.type==='in') inSum += Number(t.amount); else outSum += Number(t.amount); });
    const saldo = inSum - outSum;
    saldoEl.textContent = money(saldo);
    sumInEl.textContent = money(inSum);
    sumOutEl.textContent = money(outSum);
    countEl.textContent = tx.length;
    quickSaldo.textContent = money(saldo);
    lastUpdate.textContent = tx.length ? ('Terakhir: ' + new Date(tx[tx.length-1].date).toLocaleString('id-ID')) : 'Belum ada transaksi';
  }

  function applyFilterAndRender(){
    let list = [...tx].sort((a,b) => new Date(b.date) - new Date(a.date));
    const ft = filterType.value;
    if(ft !== 'all') list = list.filter(x => x.type === ft);
    if(filterFrom.value) {
      const min = new Date(filterFrom.value + 'T00:00:00');
      list = list.filter(x => new Date(x.date) >= min);
    }
    if(filterTo.value) {
      const max = new Date(filterTo.value + 'T23:59:59');
      list = list.filter(x => new Date(x.date) <= max);
    }
    updateUI(list);
  }

  // refresh full UI (recompute & render)
  function refreshAll(){
    saveAll();
    applyFilterAndRender();
  }

  // --- Add transaction ---
  addBtn.addEventListener('click', () => {
    addTransactionFromInputs();
  });
  [amtEl, descEl].forEach(i => i.addEventListener('keydown', e => { if(e.key === 'Enter') addBtn.click(); }));

  function addTransactionFromInputs(){
    const amount = Math.round(Number(amtEl.value) || 0);
    const desc = (descEl.value || '').trim();
    const date = dateEl.value || todayISO;
    const tp = typeEl.value;
    if(!amount || amount <= 0){ alert('Masukkan jumlah yang valid (>0)'); amtEl.focus(); return; }
    if(!desc && !confirm('Deskripsi kosong. Lanjutkan?')) return;
    const t = { id: uid(), type: tp, amount: amount, desc: desc || (tp==='in' ? 'Pemasukan' : 'Pengeluaran'), date: date };
    tx.push(t);
    saveAll();
    refreshAll();
    speak((tp==='in' ? 'Pemasukan' : 'Pengeluaran') + ' sebesar ' + amount + ' rupiah ditambahkan.');
    // clear fields for cepat input
    amtEl.value = '';
    descEl.value = '';
    amtEl.focus();
  }

  // chips quick fill
  document.querySelectorAll('.chip').forEach(c => c.addEventListener('click', () => {
    amtEl.value = Number(c.dataset.amt);
    amtEl.focus();
  }));

  // filter buttons
  applyFilter.addEventListener('click', applyFilterAndRender);
  resetFilter.addEventListener('click', () => { filterType.value='all'; filterFrom.value=''; filterTo.value=''; applyFilterAndRender(); });

  // export CSV
  function toCSV(rows){
    const header = ['Tanggal','Deskripsi','Jenis','Jumlah'];
    const lines = [header.join(',')];
    rows.forEach(r => {
      const dt = new Date(r.date).toLocaleDateString('id-ID');
      const line = [escapeCsv(dt), escapeCsv(r.desc), r.type==='in'?'Pemasukan':'Pengeluaran', r.amount];
      lines.push(line.join(','));
    });
    return lines.join('\n');
  }
  function escapeCsv(s){
    if(s==null) return '';
    s = String(s);
    if(s.includes(',') || s.includes('"') || s.includes('\n')) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  }
  exportBtn.addEventListener('click', () => {
    const data = [...tx].sort((a,b)=> new Date(b.date)-new Date(a.date));
    if(!data.length){ alert('Tidak ada transaksi untuk diexport'); return; }
    const csv = toCSV(data);
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'simplekas_' + new Date().toISOString().slice(0,10) + '.csv';
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // download / upload json
  $('downloadJson').addEventListener('click', () => {
    const blob = new Blob([JSON.stringify(tx, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'simplekas_backup_' + new Date().toISOString().slice(0,10) + '.json';
    a.click();
    URL.revokeObjectURL(a.href);
  });
  openRestore.addEventListener('click', () => fileRestore.click());
  fileRestore.addEventListener('change', e => {
    const f = e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = ev => {
      try {
        const data = JSON.parse(ev.target.result);
        if(!Array.isArray(data)) throw new Error('File tidak valid');
        if(!confirm('Restore dari file backup? Data saat ini akan diganti.')) return;
        tx = data;
        saveAll(); refreshAll();
        speak('Data berhasil dipulihkan dari file');
        alert('Restore selesai');
      } catch(err) {
        alert('Gagal membaca file: ' + err.message);
      }
    };
    r.readAsText(f);
    fileRestore.value = '';
  });

  // print
  printBtn.addEventListener('click', () => window.print());

  // Reset month manually (arsip dan kosongkan)
  resetMonthBtn.addEventListener('click', () => {
    if(!confirm('Reset sekarang? Data bulan ini akan diarsipkan dan data saat ini akan dikosongkan.')) return;
    const currentMonth = localStorage.getItem(KEY_MONTH) || monthKey();
    const arch = loadArchive();
    const currentData = loadAll() || [];
    if(currentData.length) { arch[currentMonth] = currentData; saveArchive(arch); }
    tx = []; saveAll();
    localStorage.setItem(KEY_MONTH, monthKey());
    refreshAll();
    alert('Reset selesai. Arsip tersimpan.');
    speak('Reset selesai. Arsip tersimpan.');
  });

  // voice toggle
  voiceToggle.addEventListener('click', () => {
    voice = !voice;
    localStorage.setItem(KEY_VOICE, JSON.stringify(voice));
    updateVoiceLabel();
  });
  function updateVoiceLabel(){ voiceToggle.textContent = voice ? 'üîä Suara: On' : 'üîà Suara: Off'; }

  // initial monthly check & load
  doMonthlyCheck();
  refreshAll();

  // accessibility: announce changes for screen readers
  function announce(text){
    const sr = $('sr');
    sr.textContent = text;
    setTimeout(()=> sr.textContent = '', 1500);
  }

  // announce on add via MutationObserver? We call speak and announce on actions above.

  // Save automatically on unload (redundant but safe)
  window.addEventListener('beforeunload', () => saveAll());

  // make sure UI shows after load
  applyFilterAndRender();

})();
</script>
</body>
</html>
